import ipaddress
import sqlite3
import uuid
import json
import logging
from datetime import datetime, timedelta
from typing import Dict, Optional, List

from fastapi import FastAPI, Request, HTTPException, Depends
from fastapi.responses import JSONResponse
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
import uvicorn

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("teamserver")

security = HTTPBearer()

DEV_MODE = True  # flip to False when you want strict internal-only


class InternalC2Server:
    def __init__(self, server_id: str, config: Dict):
        self.server_id = server_id
        self.config = config
        self.db_path = config.get("database_path", "teamserver.db")

        self.internal_networks = [
            ipaddress.ip_network(net)
            for net in config.get("internal_networks", [])
        ]

        self.app = FastAPI(
            title="Internal C2 TeamServer",
            docs_url="/docs" if DEV_MODE else None,
            redoc_url="/redoc" if DEV_MODE else None,
            openapi_url="/openapi.json" if DEV_MODE else None,
        )

        self._init_db()
        self._setup_middleware()
        self._setup_routes()

    def _init_db(self):
        conn = sqlite3.connect(self.db_path)
        c = conn.cursor()

        c.execute("""
        CREATE TABLE IF NOT EXISTS agents (
            id TEXT PRIMARY KEY,
            hostname TEXT,
            username TEXT,
            ip_address TEXT,
            last_seen TEXT,
            status TEXT
        )
        """)

        c.execute("""
        CREATE TABLE IF NOT EXISTS tasks (
            id TEXT PRIMARY KEY,
            agent_id TEXT,
            command TEXT,
            created_at TEXT,
            status TEXT,
            result TEXT
        )
        """)

        conn.commit()
        conn.close()
        logger.info(f"Database initialized: {self.db_path}")

    def _is_internal_ip(self, ip: str) -> bool:
        ip_obj = ipaddress.ip_address(ip)
        return any(ip_obj in net for net in self.internal_networks)

    def _setup_middleware(self):
        @self.app.middleware("http")
        async def internal_only(request: Request, call_next):
            client_ip = request.client.host

            # Allow docs locally in dev mode
            if DEV_MODE and request.url.path in ["/docs", "/openapi.json", "/redoc"]:
                return await call_next(request)

            if not self._is_internal_ip(client_ip):
                return JSONResponse(
                    status_code=403,
                    content={"error": "Access denied - internal only"}
                )

            return await call_next(request)

    def _verify_agent_token(self, token: str) -> bool:
        return token.startswith("AGENT-")

    def _setup_routes(self):
        @self.app.get("/health")
        async def health():
            return {
                "status": "ok",
                "server_id": self.server_id,
                "time": datetime.utcnow().isoformat()
            }

        @self.app.post("/api/v1/beacon")
        async def beacon(request: Request, creds: HTTPAuthorizationCredentials = Depends(security)):
            if not self._verify_agent_token(creds.credentials):
                raise HTTPException(status_code=401, detail="Invalid agent token")

            data = await request.json()
            agent_id = data.get("agent_id")

            if not agent_id:
                raise HTTPException(status_code=400, detail="Missing agent_id")

            conn = sqlite3.connect(self.db_path)
            c = conn.cursor()

            now = datetime.utcnow().isoformat()
            c.execute("""
            INSERT OR REPLACE INTO agents (id, hostname, username, ip_address, last_seen, status)
            VALUES (?, ?, ?, ?, ?, ?)
            """, (
                agent_id,
                data.get("hostname"),
                data.get("username"),
                request.client.host,
                now,
                "online"
            ))

            c.execute("SELECT id, command FROM tasks WHERE agent_id = ? AND status = 'pending'", (agent_id,))
            tasks = [{"id": t[0], "command": t[1]} for t in c.fetchall()]

            conn.commit()
            conn.close()

            return {"tasks": tasks, "next_beacon": 30}

        @self.app.post("/api/v1/results")
        async def results(request: Request, creds: HTTPAuthorizationCredentials = Depends(security)):
            if not self._verify_agent_token(creds.credentials):
                raise HTTPException(status_code=401, detail="Invalid agent token")

            data = await request.json()
            task_id = data.get("task_id")
            result = data.get("result")

            conn = sqlite3.connect(self.db_path)
            c = conn.cursor()

            c.execute("""
            UPDATE tasks SET status = 'completed', result = ?
            WHERE id = ?
            """, (result, task_id))

            conn.commit()
            conn.close()

            return {"status": "ok"}

        @self.app.post("/api/v1/task")
        async def create_task(request: Request):
            data = await request.json()

            task_id = str(uuid.uuid4())
            agent_id = data.get("agent_id")
            command = data.get("command")

            conn = sqlite3.connect(self.db_path)
            c = conn.cursor()

            c.execute("""
            INSERT INTO tasks (id, agent_id, command, created_at, status)
            VALUES (?, ?, ?, ?, ?)
            """, (
                task_id,
                agent_id,
                command,
                datetime.utcnow().isoformat(),
                "pending"
            ))

            conn.commit()
            conn.close()

            return {"task_id": task_id}

    def start(self, host="0.0.0.0", port=8443):
        uvicorn.run(self.app, host=host, port=port, log_level="info")


if __name__ == "__main__":
    config = {
        "database_path": "teamserver.db",
        "internal_networks": ["10.0.0.0/8", "127.0.0.1/32"]
    }

    server = InternalC2Server("teamserver-primary-01", config)

    print(f"""
    INTERNAL C2 TEAMSERVER (LAB MODE)

    Server ID: {server.server_id}
    Port: 8443
    Dev Mode: {DEV_MODE}

    """)

    server.start()
